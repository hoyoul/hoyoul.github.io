<!DOCTYPE html>
<html>
  <head><title>[emacs] org backend 만들기</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes" />

<link rel="shortcut icon" href="./img/favicon.ico" type="image/x-icon">
<link rel="icon" href="./img/favicon.ico" type="image/x-icon">    

<link rel="stylesheet" href="/css/main.css">

</head>
  <body><header>
  <a href="/" id="logo">
    <img src="http://braindump.frege2godel.me/img/mylogo.png" alt="holy frege">
    <h3><span>H</span>oly <span>F</span>rege's <span id="note">notes</span></h3>
  </a>
    <small>G.frege를 너무 사랑하는 holy가...</small>  
</header>

<div class="container">
  <div class="page">
    <h1 class="collapsed-title">[emacs] org backend 만들기</h1>    
      <div class="content">
	<a href="http://braindump.frege2godel.me/posts/emacs_org_backend_%E1%84%86%E1%85%A1%E1%86%AB%E1%84%83%E1%85%B3%E1%86%AF%E1%84%80%E1%85%B5/" alt="[emacs] org backend 만들기" class="permalink"><h1>[emacs] org backend 만들기</h1></a>      
	<h2 id="참고">참고</h2>
<p><a href="https://www.reddit.com/r/emacs/comments/swvbmm/you_want_to_write_a_custom_org_backend_lets_write/">참고</a></p>
<h2 id="prerequisite">prerequisite</h2>
<p>org backend를 알기위해선 아래의 파일에 대한 분석이 필요하다고
한다. 다음 소스는 아래에서 얻을 수 있다. org는 emacs에 built-in되어
있다.</p>
<div class="important">
<p>git clone <a href="https://git.savannah.gnu.org/git/emacs/org-mode.git">https://git.savannah.gnu.org/git/emacs/org-mode.git</a></p>
</div>
<h3 id="ox-dot-el--org-export-framework">ox.el (org export framework)</h3>
<h3 id="ox-html-dot-el--org-export-html">ox-html.el (org export html)</h3>
<h3 id="ox-md-dot-el--org-export-md">ox-md.el (org export md)</h3>
<h3 id="ox-org-dot-el--org-export-org--y">ox-org.el (org export org)y</h3>
<h3 id="testing-lisp-test-dot-ox-dot-el">testing/lisp/test.ox.el</h3>
<h2 id="목적">목적</h2>
<p>org문서를 다른 형태의 문서로 변환하기 위해선 backend라는게
필요하다. org-export를 통해서 변환하는데, 이때 backend가 사용되기
때문이다. 여기서 다루는 것은 간단한 예제다.
다음과 같은 org buffer가 있다고 하자.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-org" data-lang="org"><span style="display:flex;"><span>I like <span style="font-weight:bold">*bold-1*</span> and <span style="font-weight:bold">*bold-2*</span> and you?
</span></span><span style="display:flex;"><span>I don&#39;t.  I prefer <span style="font-weight:bold">*bold-3*</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I&#39;ve loved <span style="font-weight:bold">*bold-4*</span> since I was a child.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I&#39;m <span style="font-style:italic">/italic/</span>.
</span></span></code></pre></div><p>위의 org buffer를 다음과 같은 형태로 변환 해보자. org buffer에서
또다른 buffer로 바꾸는 것이다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-org" data-lang="org"><span style="display:flex;"><span>&lt;<span style="color:#4070a0">--::***bold-1*** ***bold-2*** ***bold-3***::
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0">
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0">
</span></span></span><span style="display:flex;"><span><span style="color:#4070a0">::***bold-4*** ::--</span>&gt;
</span></span></code></pre></div><h2 id="org-export-mechanism">org export mechanism</h2>
<p>org에서 org문서를 export할때 2가지를 한다. parsing과 traversing이다.</p>
<ol>
<li>org buffer의 내용을 parse한다. 그결과 org buffer의 내용이
tree형태로 구성되게 된다.</li>
<li>tree 노드들에는 transcode function이 있다. tree를 traverse하면서
transcode function을 수행시키고 결과 string을 다른 buffer에 붙인다.</li>
</ol>
<p>우리가 test할 project의 이름은 only-bold인데, 가장 간단한
org-backend로 transcode function만을 사용할 것이다.</p>
<h2 id="transcoder-org-export-define-backend-and-org-export-to-buffer-dot">transcoder,org-export-define-backend and org-export-to-buffer.</h2>
<h3 id="org-export-define-backend">org-export-define-backend</h3>
<p>제일 먼저 backend를 만든다. org-export-define-backend라는 함수는
backend를 만드는 핵심 함수다. 이 함수로 backend를 만든다. 함수에는 몇
개의 인자가 필요하다. 여기서는 backend의 이름과 list of transcoder
두개만 사용해서 backend를 만든다. 아래를 보자.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#bb60d5">org-export-define-backend</span> <span style="color:#517918">&#39;onlybold</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">&#39;</span>((<span style="color:#bb60d5">bold</span> <span style="color:#666">.</span> <span style="color:#bb60d5">onlybold-bold</span>)))
</span></span></code></pre></div><p>onlybold는 backend 이름과 a list of transcoder다. 보면 bold가 있고,
onlybold-bold라는게 있다. bold는 org buffer를 parsing했을때 나오는
org-element를 적고 그 다음 그 element를 만나면 onlybold-bold라는
transcoder를 호출하겠다. 라고 정의한다.</p>
<h3 id="transcoder-function">transcoder function</h3>
<p>위와 같이 org backend를 정의했으면, backend에서 호출하는 transcoder도
정의해야 한다. backend에서 transcoder에 3개의 인자를 전달 한다.</p>
<ol>
<li>element: parsing tree의 element</li>
<li>contents:element의 childeren element</li>
<li>info: #+Title: #+DATE, #+Author같은 org buffer의 option정보가
transcoder에 전달된다.</li>
</ol>
<p>위 3개의 인자를 사용할 지 안 할지는 선택 사항이다. backend에서
transcoder의 이름을 onlybold-bold로 했기 때문에 그 이름으로 function을
정의하자.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#007020">defun</span> <span style="color:#bb60d5">onlybold-bold</span> (<span style="color:#bb60d5">bold</span> <span style="color:#bb60d5">contents</span> <span style="color:#bb60d5">info</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#06287e">concat</span> <span style="color:#4070a0">&#34;***&#34;</span> <span style="color:#bb60d5">contents</span> <span style="color:#4070a0">&#34;***&#34;</span>))
</span></span></code></pre></div><p>이렇게 정의하면, 전달받은 3개의 인자중 contents만 사용한다.</p>
<p>이제 backend를 호출하면, org-buffer를 parsing해서 transcoder를
호출하게 된다. 그리고 transcoder는 문자열을 출력한다. 이 출력을 버퍼에
저장하면 된다. 이렇게 하려면, 사용되는 함수가 있다.</p>
<h3 id="org-export-to-buffer">org-export-to-buffer</h3>
<p>org-export-to-buffer는 backend를 호출한다. 그리고 transcoder가
출력하는 문자열을 저장할 buffer도 지정한다. org-export-to-buffer를
호출하는 함수를 만들어 보자.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#007020">defun</span> <span style="color:#bb60d5">onlybold-export</span> ()
</span></span><span style="display:flex;"><span>  (<span style="color:#007020">interactive</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#bb60d5">org-export-to-buffer</span> <span style="color:#517918">&#39;onlybold</span> <span style="color:#4070a0">&#34;*onlybold*&#34;</span>))
</span></span></code></pre></div><p>이렇게 하고 org buffer에서 M-x onlybold-export()를 호출하자. 그러면
*onlybold*라는 buffer에 transcoder 출력 string이 보여질거라고
생각하지만, 그렇지 않다. 어디서 문제가 생긴것일까?</p>
<h3 id="문제">문제</h3>
<p>문제는 backend에서 정의된 org element가 정확히 명시되지 않았다는
것이다. 그렇기 때문에 transcoder에서 translate가 일어나지 않았다는
것이다. backend에선 단순히 bold element라고 정의했다. 이것은
top-level에서 bold element를 처리하겠다는 뜻이다. 그런데 우리가
사용하는 org file에선 bold element는 top-level에는 없다.  org file에서
bold element는 hiearchy에 의해서 section&gt;paragraph&gt;bold element가
있다.</p>
<p>따라서 정확한 위치를 기술해야 한다. 이를 위해선 org-parse tree를
확인해야 하는데, 이렇게 하기위해선 다음과 같이 실행해야 한다.</p>
<div class="important">
<p>M-x pp-eval-expression RET (org-element-parse-buffer)</p>
</div>
<p>org-element-parse-buffer라는 함수는 interactive하지 않다. 일반
함수다. 따라서 eval-expression을 사용해야 실행할 수 있다. pp는
tree구조를 잘보여주는 evaluation이다.</p>
<h3 id="재작성">재작성</h3>
<p>위에서 말했듯이 bold라는 transcoder를 만들면 parse tree의
top-level에서 bold element를 찾는다. section&gt; paragraph&gt; bold
element를 찾아서 transcoder를 처리하려면 section을 정의해야
한다. 그래야 parse tree에서 section node를 검색한다. section에서
paragraph를 검색하기 위해선 paragraph transcoder를 정의해야 section&gt;
paragraph 처리가 가능하다. 그래서 2개의 transcoder를 작성한다.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#007020">defun</span> <span style="color:#bb60d5">onlybold-section</span> (<span style="color:#bb60d5">section</span> <span style="color:#bb60d5">contents</span> <span style="color:#bb60d5">info</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#06287e">concat</span> <span style="color:#4070a0">&#34;&lt;--&#34;</span> <span style="color:#bb60d5">contents</span> <span style="color:#4070a0">&#34;--&gt;&#34;</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#007020">defun</span> <span style="color:#bb60d5">onlybold-paragraph</span> (<span style="color:#bb60d5">paragraph</span> <span style="color:#bb60d5">contents</span> <span style="color:#bb60d5">info</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#06287e">concat</span> <span style="color:#4070a0">&#34;::&#34;</span> <span style="color:#bb60d5">contents</span> <span style="color:#4070a0">&#34;::&#34;</span>))
</span></span></code></pre></div><p>그리고 backend를 다시 작성하자.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#bb60d5">org-export-define-backend</span> <span style="color:#517918">&#39;onlybold</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">&#39;</span>((<span style="color:#bb60d5">bold</span> <span style="color:#666">.</span> <span style="color:#bb60d5">onlybold-bold</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#bb60d5">section</span> <span style="color:#666">.</span> <span style="color:#bb60d5">onlybold-section</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#bb60d5">paragraph</span> <span style="color:#666">.</span> <span style="color:#bb60d5">onlybold-paragraph</span>)))
</span></span></code></pre></div>      
      </div>
        
  
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
    
     
  

  

  </div>
</div>  

<script src="/js/URI.js" type="text/javascript"></script>
<script src="/js/page.js" type="text/javascript"></script>
</body>
</html>
